<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel IrrigaÃ§Ã£o (HiveMQ Cloud + MQTT)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:18px;max-width:980px;background:#f6f7fb}
    h1{margin:0 0 10px 0;font-size:20px}
    h2{margin:0 0 10px 0;font-size:16px}
    .small{font-size:12px;color:#666}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px 14px;background:#fff;flex:1;min-width:280px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    label{display:block;font-size:13px;margin:8px 0 4px}
    input,button{font-size:14px;padding:10px;border-radius:10px;border:1px solid #ccc}
    button{cursor:pointer;border:none}
    .btn{background:#0d6efd;color:#fff}
    .btn2{background:#198754;color:#fff}
    .btn3{background:#dc3545;color:#fff}
    .btnGray{background:#6c757d;color:#fff}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:13px;vertical-align:top}
    .mono{font-family:ui-monospace,Consolas,monospace}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eee;font-weight:700}
    .ok{background:#d6f5dd;color:#0a7a2f}
    .bad{background:#ffe0e0;color:#b00020}
    pre{background:#0b1020;color:#e8edf7;padding:10px;border-radius:12px;overflow:auto;white-space:pre-wrap}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }
  </style>

  <!-- mqtt.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>

<body>
  <h1>ðŸŒ¿ Painel IrrigaÃ§Ã£o (HiveMQ Cloud + MQTT)</h1>

  <div class="small">
    Dispositivo: <b class="mono" id="devLbl">â€”</b> â€¢ Base: <b class="mono" id="baseLbl">â€”</b>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <h2>1) ConexÃ£o MQTT (WebSocket)</h2>

      <div class="grid">
        <div>
          <label>DEVICE_ID (tem que bater com o ESP32)</label>
          <input id="deviceId" class="mono" style="width:100%" placeholder="irrigacao01"/>
        </div>
        <div>
          <label>TÃ³picos</label>
          <div class="small mono" id="topicsLbl">â€”</div>
        </div>
      </div>

      <label>Host (sem porta, sem /mqtt)</label>
      <input id="host" class="mono" style="width:100%" placeholder="f39abc...hivemq.cloud"/>

      <div class="row">
        <div style="flex:1;min-width:140px">
          <label>Porta</label>
          <input id="port" class="mono" style="width:100%" placeholder="8884"/>
        </div>
        <div style="flex:1;min-width:140px">
          <label>Path</label>
          <input id="path" class="mono" style="width:100%" placeholder="/mqtt"/>
        </div>
      </div>

      <div class="row">
        <div style="flex:1;min-width:160px">
          <label>UsuÃ¡rio MQTT</label>
          <input id="user" class="mono" style="width:100%" placeholder="seu usuÃ¡rio"/>
        </div>
        <div style="flex:1;min-width:160px">
          <label>Senha MQTT</label>
          <input id="pass" type="password" class="mono" style="width:100%" placeholder="sua senha"/>
        </div>
      </div>

      <div class="btns">
        <button class="btn" onclick="connect()">Conectar</button>
        <button class="btnGray" onclick="disconnect()">Desconectar</button>
        <span id="state" class="pill bad">desconectado</span>
      </div>

      <div class="small" style="margin-top:10px">
        No HiveMQ Cloud normalmente Ã© <b>WSS</b> na porta <b>8884</b> com path <b>/mqtt</b>.
      </div>
    </div>

    <div class="card">
      <h2>2) Status</h2>

      <table>
        <tr><th>Ãšltima atualizaÃ§Ã£o</th><td id="lastSeen">â€”</td></tr>
        <tr><th>IP</th><td id="ip">â€”</td></tr>
        <tr><th>RSSI</th><td id="rssi">â€”</td></tr>
        <tr><th>Modo</th><td id="mode">â€”</td></tr>
        <tr><th>RelÃ©</th><td id="relay">â€”</td></tr>
        <tr><th>Irrigando</th><td id="watering">â€”</td></tr>
        <tr><th>ADC</th><td id="adcRaw">â€”</td></tr>
        <tr><th>Estado</th><td id="moistureState">â€”</td></tr>
        <tr><th>% Umidade</th><td id="moisturePct">â€”</td></tr>
        <tr><th>Threshold</th><td id="thrNow">â€”</td></tr>
        <tr><th>read</th><td id="readMsNow">â€”</td></tr>
        <tr><th>irrig mÃ¡x</th><td id="irrMsNow">â€”</td></tr>
        <tr><th>StableN</th><td id="stableNNow">â€”</td></tr>
        <tr><th>Contadores</th><td id="counts">â€”</td></tr>
        <tr><th>Uptime</th><td id="uptime">â€”</td></tr>
      </table>

      <hr/>

      <h2>3) Comandos</h2>

      <div class="btns">
        <button class="btn2" onclick="cmdMode('AUTO')">AUTO</button>
        <button class="btnGray" onclick="cmdMode('MANUAL')">MANUAL</button>
        <button class="btn2" onclick="cmdManual('ON')">FORÃ‡AR ON</button>
        <button class="btn3" onclick="cmdManual('OFF')">FORÃ‡AR OFF</button>
      </div>

      <label style="margin-top:12px">Config</label>
      <div class="grid">
        <div>
          <label>Threshold</label>
          <input id="inThr" type="number" class="mono" placeholder="1900"/>
        </div>
        <div>
          <label>StableN</label>
          <input id="inStableN" type="number" class="mono" placeholder="3"/>
        </div>
        <div>
          <label>read (min)</label>
          <input id="inReadMin" type="number" step="0.1" class="mono" placeholder="30"/>
        </div>
        <div>
          <label>irrig mÃ¡x (min)</label>
          <input id="inIrrMin" type="number" step="0.1" class="mono" placeholder="5"/>
        </div>
      </div>

      <div class="btns">
        <button class="btn" onclick="cmdSet()">Salvar Config</button>
      </div>

      <div class="small">
        Dica: aceita vÃ­rgula ou ponto nos minutos (ex.: <span class="mono">0,5</span> = 30s).
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <h2>4) Logs (tÃ³pico <span class="mono" id="logsTopicLbl">â€”</span>)</h2>
      <table style="margin-top:8px">
        <thead>
          <tr>
            <th>#</th><th>InÃ­cio</th><th>Fim</th><th>Motivo</th><th>ADC iniâ†’fim</th>
          </tr>
        </thead>
        <tbody id="logsBody"></tbody>
      </table>

      <hr/>
      <h2>Debug</h2>
      <pre id="dbg">â€”</pre>
    </div>
  </div>

<script>
  // ======= Defaults (nÃ£o perdem seus endereÃ§os/login) =======
  const DEFAULT_DEVICE_ID = localStorage.getItem("device_id") || "irrigacao01";
  const DEFAULT_HOST = localStorage.getItem("mqtt_host") || "f39abc7b833944818687793a7175eed4.s1.eu.hivemq.cloud";
  const DEFAULT_PORT = localStorage.getItem("mqtt_port") || "8884";
  const DEFAULT_PATH = localStorage.getItem("mqtt_path") || "/mqtt";

  document.getElementById("deviceId").value = DEFAULT_DEVICE_ID;
  document.getElementById("host").value = DEFAULT_HOST;
  document.getElementById("port").value = DEFAULT_PORT;
  document.getElementById("path").value = DEFAULT_PATH;
  document.getElementById("user").value = localStorage.getItem("mqtt_user") || "";
  document.getElementById("pass").value = localStorage.getItem("mqtt_pass") || "";

  let DEVICE_ID = (document.getElementById("deviceId").value || "").trim() || "irrigacao01";
  let BASE = `irrigacao/${DEVICE_ID}`;
  let T_CMD = `${BASE}/cmd`;
  let T_ACK = `${BASE}/ack`;
  let T_STATUS = `${BASE}/status`;
  let T_LOGS = `${BASE}/logs`;

  function refreshTopicLabels(){
    DEVICE_ID = (document.getElementById("deviceId").value || "").trim() || "irrigacao01";
    BASE = `irrigacao/${DEVICE_ID}`;
    T_CMD = `${BASE}/cmd`;
    T_ACK = `${BASE}/ack`;
    T_STATUS = `${BASE}/status`;
    T_LOGS = `${BASE}/logs`;

    document.getElementById("devLbl").textContent = DEVICE_ID;
    document.getElementById("baseLbl").textContent = BASE;
    document.getElementById("topicsLbl").textContent = `${T_STATUS} â€¢ ${T_LOGS} â€¢ ${T_ACK} â€¢ (cmdâ†’ ${T_CMD})`;
    document.getElementById("logsTopicLbl").textContent = T_LOGS;
  }
  refreshTopicLabels();

  document.getElementById("deviceId").addEventListener("change", () => {
    refreshTopicLabels();
  });

  // ======= UI helpers =======
  function setPill(ok, txt){
    const el = document.getElementById("state");
    el.textContent = txt;
    el.className = "pill " + (ok ? "ok" : "bad");
  }
  function setText(id, v){
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = (v === undefined || v === null) ? "â€”" : String(v);
  }
  function dbg(msg){
    const el = document.getElementById("dbg");
    const t = new Date().toLocaleString("pt-BR");
    const line = `[${t}] ${msg}\n`;
    el.textContent = (el.textContent === "â€”" ? "" : el.textContent);
    el.textContent = line + el.textContent;
    console.log(msg);
  }

  function translateMode(m){
    const x = String(m || "").toUpperCase();
    if(x === "AUTO") return "AUTO";
    if(x === "MANUAL") return "MANUAL";
    if(x === "FORCE_ON") return "FORÃ‡AR ON";
    if(x === "FORCE_OFF") return "FORÃ‡AR OFF";
    return m ?? "â€”";
  }
  function translateState(s){
    const x = String(s || "").toLowerCase();
    if(x === "seco") return "SECO";
    if(x === "molhado") return "MOLHADO";
    if(x === "limite") return "LIMITE";
    return s ?? "â€”";
  }

  // ======= MQTT client =======
  let client = null;

  function connect(){
    refreshTopicLabels();

    const host = (document.getElementById("host").value || "").trim();
    const port = (document.getElementById("port").value || "").trim();
    const path = (document.getElementById("path").value || "/mqtt").trim();
    const user = (document.getElementById("user").value || "").trim();
    const pass = (document.getElementById("pass").value || "");

    // salva (local) â€” nÃ£o perde login/endereÃ§o
    localStorage.setItem("device_id", DEVICE_ID);
    localStorage.setItem("mqtt_host", host);
    localStorage.setItem("mqtt_port", port);
    localStorage.setItem("mqtt_path", path);
    localStorage.setItem("mqtt_user", user);
    localStorage.setItem("mqtt_pass", pass);

    if(!host){
      alert("Preencha o Host (ex.: f39...hivemq.cloud).");
      return;
    }
    if(host.includes("/") || host.includes(":")){
      alert("No campo Host coloque SOMENTE o domÃ­nio, sem porta e sem /mqtt.\nExemplo: f39abc...hivemq.cloud");
      return;
    }

    const url = `wss://${host}:${port}${path}`;
    const clientId = `web-${DEVICE_ID}-${Math.random().toString(16).slice(2)}`;

    dbg(`Conectando em ${url}`);
    setPill(false, "conectando.");

    if(client){
      try{ client.end(true); }catch(e){}
      client = null;
    }

    client = mqtt.connect(url, {
      clientId,
      username: user || undefined,
      password: pass || undefined,
      protocolVersion: 4,
      clean: true,
      keepalive: 30,
      reconnectPeriod: 2000,
      connectTimeout: 10000
    });

    client.on("connect", () => {
      setPill(true, "conectado");
      dbg("âœ… CONNECT");
      client.subscribe([T_STATUS, T_LOGS, T_ACK], { qos: 0 }, (err) => {
        if(err) dbg("âŒ SUB error: " + err.message);
        else dbg("ðŸ“¡ Subscribed: status/logs/ack");
      });
    });

    client.on("reconnect", () => { setPill(false, "reconectando."); dbg("â†©ï¸ RECONNECT"); });
    client.on("close", () => { setPill(false, "desconectado"); dbg("ðŸ”Œ CLOSE"); });
    client.on("offline", () => { setPill(false, "offline"); dbg("ðŸ“´ OFFLINE"); });
    client.on("error", (e) => { setPill(false, "erro"); dbg("âŒ ERROR: " + (e?.message || e)); });

    client.on("message", (topic, payload) => {
      const txt = payload.toString();

      if(topic === T_STATUS){
        try{
          const s = JSON.parse(txt);
          setText("lastSeen", new Date().toLocaleString("pt-BR"));

          // ---- Compatibilidade: aceita status do firmware antigo OU novo ----
          const ip = s.ip ?? "â€”";
          const rssi = s.rssi ?? "â€”";
          const mode = translateMode(s.mode);

          // relay (antigo: "on/off") ou relayOn bool (novo)
          const relay =
            (typeof s.relay === "string")
              ? (s.relay === "on" ? "LIGADO" : "DESLIGADO")
              : (typeof s.relayOn === "boolean")
                  ? (s.relayOn ? "LIGADO" : "DESLIGADO")
                  : "â€”";

          const watering = (s.watering === true) ? "SIM" : (s.watering === false ? "NÃƒO" : "â€”");

          const adc = (s.adcRaw ?? s.adc ?? "â€”");
          const st = translateState(s.moistureState ?? s.state);
          const pct = (s.moisturePct ?? "â€”");

          const thr = s.threshold ?? "â€”";
          const readMs = s.readMs ?? "â€”";
          const irrMs = s.irrMs ?? "â€”";
          const stableN = s.stableN ?? "â€”";
          const counts = `${s.aboveCount ?? "â€”"} / ${s.belowCount ?? "â€”"}`;
          const uptime = s.uptimeMs ?? "â€”";

          setText("ip", ip);
          setText("rssi", rssi);
          setText("mode", mode);
          setText("relay", relay);
          setText("watering", watering);
          setText("adcRaw", adc);
          setText("moistureState", st);
          setText("moisturePct", (pct === "â€”" ? "â€”" : (pct + "%")));
          setText("thrNow", thr);
          setText("readMsNow", readMs);
          setText("irrMsNow", irrMs);
          setText("stableNNow", stableN);
          setText("counts", counts);
          setText("uptime", uptime);

          // preenche inputs sÃ³ se vazios (nÃ£o atrapalhar digitaÃ§Ã£o)
          const inThr = document.getElementById("inThr");
          const inStableN = document.getElementById("inStableN");
          const inReadMin = document.getElementById("inReadMin");
          const inIrrMin = document.getElementById("inIrrMin");

          if(inThr && !inThr.value) inThr.value = thr;
          if(inStableN && !inStableN.value) inStableN.value = stableN;

          // se vier em ms, mostra em minutos para ediÃ§Ã£o
          if(inReadMin && !inReadMin.value && readMs !== "â€”") inReadMin.value = (Number(readMs)/60000).toFixed(1).replace(/\.0$/, '');
          if(inIrrMin && !inIrrMin.value && irrMs !== "â€”") inIrrMin.value = (Number(irrMs)/60000).toFixed(1).replace(/\.0$/, '');

        }catch(e){
          dbg("âŒ STATUS JSON invÃ¡lido");
        }
        return;
      }

      if(topic === T_LOGS){
        try{
          const lg = JSON.parse(txt);
          renderLogsCompat(lg);
        }catch(e){
          dbg("âŒ LOGS JSON invÃ¡lido");
        }
        return;
      }

      if(topic === T_ACK){
        dbg("ðŸŸ¦ ACK: " + txt);
        return;
      }
    });
  }

  function disconnect(){
    if(client){
      try{ client.end(true); }catch(e){}
      client = null;
    }
    setPill(false, "desconectado");
    dbg("ðŸ”Œ DISCONNECT");
  }

  function publishCmd(obj){
    if(!client || !client.connected){
      alert("Conecte no MQTT primeiro.");
      return;
    }
    const msg = JSON.stringify(obj);
    dbg("âž¡ï¸ CMD " + msg);
    client.publish(T_CMD, msg, { qos: 0, retain: false });
  }

  // ---- Envio compatÃ­vel (manda nos 2 formatos) ----
  function cmdMode(m){
    // formato â€œantigoâ€
    publishCmd({ mode: m });
    // formato â€œnovoâ€
    publishCmd({ cmd: "mode", value: m });
  }

  function cmdManual(v){
    publishCmd({ manual: v });
    publishCmd({ cmd: "manual", value: v });
  }

  function cmdSet(){
    const thr = Number(document.getElementById("inThr").value || 0);
    const stableN = Number(document.getElementById("inStableN").value || 1);

    // minutos aceitam vÃ­rgula
    const readMinTxt = (document.getElementById("inReadMin").value || "0").replace(",", ".");
    const irrMinTxt  = (document.getElementById("inIrrMin").value  || "0").replace(",", ".");
    const readMs = Math.round(parseFloat(readMinTxt) * 60000);
    const irrMs  = Math.round(parseFloat(irrMinTxt)  * 60000);

    // formato â€œantigoâ€
    publishCmd({ set: { threshold: thr, readMs, irrMs, stableN } });
    // formato â€œnovoâ€
    publishCmd({ cmd: "set", threshold: thr, readMs, irrMs, stableN });
  }

  // ---- Logs compatÃ­veis ----
  function renderLogsCompat(lg){
    const body = document.getElementById("logsBody");
    body.innerHTML = "";

    // pode vir:
    // - antigo: { items:[...] } com startEpoch/endEpoch/startAdc/endAdc/stopReason
    // - novo:   { items:[...] } com startLocal/endLocal/adcStart/adcEnd/reason
    const items = lg.items || [];

    items.forEach((it, i) => {
      const tr = document.createElement("tr");

      const start = it.startLocal ?? it.start ?? (it.startEpoch ? new Date(it.startEpoch*1000).toLocaleString("pt-BR") : "â€”");
      const end   = it.endLocal   ?? it.end   ?? (it.endEpoch   ? new Date(it.endEpoch*1000).toLocaleString("pt-BR") : "â€”");

      const reason = it.reason ?? it.stopReason ?? "â€”";

      const a0 = it.adcStart ?? it.startAdc ?? "â€”";
      const a1 = it.adcEnd   ?? it.endAdc   ?? "â€”";

      tr.innerHTML = `<td>${i+1}</td><td>${start}</td><td>${end}</td><td>${reason}</td><td>${a0}â†’${a1}</td>`;
      body.appendChild(tr);
    });
  }

</script>
</body>
</html>
