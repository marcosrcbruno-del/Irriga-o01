<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel IrrigaÃ§Ã£o (MQTT)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:18px;max-width:980px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px 14px;flex:1;min-width:280px}
    h1{margin:0 0 10px 0;font-size:20px}
    h2{margin:0 0 10px 0;font-size:16px}
    label{display:block;font-size:13px;margin:8px 0 4px}
    input,select,button{font-size:14px;padding:8px;border-radius:8px;border:1px solid #ccc}
    button{cursor:pointer}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .ok{color:#0a7a2f;font-weight:600}
    .bad{color:#b00020;font-weight:600}
    pre{background:#0b1020;color:#e8edf7;padding:10px;border-radius:10px;overflow:auto}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:13px}
    .mono{font-family:ui-monospace,Consolas,monospace}
    .small{font-size:12px;color:#666}
  </style>

  <!-- mqtt.js via CDN -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <h1>ðŸŒ¿ Painel de IrrigaÃ§Ã£o (HiveMQ + MQTT)</h1>
  <div class="small">
    Dispositivo: <b class="mono" id="devIdLbl">irrigacao01</b> â€¢
    Base de tÃ³picos: <b class="mono" id="baseLbl">irrigacao/irrigacao01</b>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <h2>1) ConexÃ£o MQTT (WebSocket)</h2>

      <label>Host (HiveMQ Cloud)</label>
      <input id="host" class="mono" style="width:100%" placeholder="f39...hivemq.cloud"/>

      <div class="row">
        <div style="flex:1;min-width:160px">
          <label>Porta</label>
          <input id="port" class="mono" style="width:100%" placeholder="8884"/>
        </div>
        <div style="flex:1;min-width:160px">
          <label>Path</label>
          <input id="path" class="mono" style="width:100%" placeholder="/mqtt"/>
        </div>
      </div>

      <div class="row">
        <div style="flex:1;min-width:160px">
          <label>UsuÃ¡rio</label>
          <input id="user" class="mono" style="width:100%" placeholder="seu usuÃ¡rio"/>
        </div>
        <div style="flex:1;min-width:160px">
          <label>Senha</label>
          <input id="pass" type="password" class="mono" style="width:100%" placeholder="sua senha"/>
        </div>
      </div>

      <div class="btns">
        <button onclick="connect()">Conectar</button>
        <button onclick="disconnect()">Desconectar</button>
        <span id="connState" class="bad">Desconectado</span>
      </div>

      <div class="small" style="margin-top:10px">
        Use <b>WSS</b> (WebSocket seguro). No HiveMQ Cloud normalmente Ã© <b>porta 8884</b> com path <b>/mqtt</b>.
      </div>
    </div>

    <div class="card">
      <h2>2) Status (igual ao painel do IP)</h2>
      <table>
        <tr><th>IP</th><td class="mono" id="ip">â€”</td></tr>
        <tr><th>Wi-Fi RSSI</th><td id="rssi">â€”</td></tr>
        <tr><th>Modo</th><td id="mode">â€”</td></tr>
        <tr><th>RelÃ©</th><td id="relay">â€”</td></tr>
        <tr><th>Irrigando</th><td id="watering">â€”</td></tr>
        <tr><th>ADC</th><td class="mono" id="adcRaw">â€”</td></tr>
        <tr><th>Estado</th><td id="moistureState">â€”</td></tr>
        <tr><th>% (simples)</th><td id="moisturePct">â€”</td></tr>
        <tr><th>Threshold</th><td class="mono" id="thrNow">â€”</td></tr>
        <tr><th>Leitura (ms)</th><td class="mono" id="readMsNow">â€”</td></tr>
        <tr><th>IrrigaÃ§Ã£o mÃ¡x (ms)</th><td class="mono" id="irrMsNow">â€”</td></tr>
        <tr><th>EstÃ¡vel N</th><td class="mono" id="stableNNow">â€”</td></tr>
        <tr><th>Acima / Abaixo</th><td class="mono" id="counts">â€”</td></tr>
        <tr><th>Uptime (ms)</th><td class="mono" id="uptime">â€”</td></tr>
      </table>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <h2>3) Comandos (via MQTT)</h2>

      <div class="btns">
        <button onclick="setModeAuto()">Modo AUTO</button>
        <button onclick="manualOn()">Manual ON</button>
        <button onclick="manualOff()">Manual OFF</button>
      </div>

      <hr style="border:none;border-top:1px solid #eee;margin:12px 0">

      <h2 style="margin-top:0">ConfiguraÃ§Ã£o</h2>
      <div class="row">
        <div style="flex:1;min-width:160px">
          <label>Threshold (0â€“4095)</label>
          <input id="threshold" class="mono" style="width:100%" placeholder="1900"/>
        </div>
        <div style="flex:1;min-width:160px">
          <label>Leitura (min)</label>
          <input id="readMin" class="mono" style="width:100%" placeholder="30"/>
        </div>
        <div style="flex:1;min-width:160px">
          <label>IrrigaÃ§Ã£o (min)</label>
          <input id="irrMin" class="mono" style="width:100%" placeholder="5"/>
        </div>
        <div style="flex:1;min-width:160px">
          <label>EstÃ¡vel N (1â€“20)</label>
          <input id="stableN" class="mono" style="width:100%" placeholder="3"/>
        </div>
      </div>

      <div class="btns">
        <button onclick="saveCfg()">Salvar Config</button>
        <button onclick="requestPing()">Ping (ACK)</button>
      </div>

      <div class="small" style="margin-top:10px">
        A pÃ¡gina envia JSON em <span class="mono">irrigacao/irrigacao01/cmd</span> e recebe:
        <span class="mono">â€¦/status</span>, <span class="mono">â€¦/logs</span> e <span class="mono">â€¦/ack</span>.
      </div>
    </div>

    <div class="card">
      <h2>4) Logs de IrrigaÃ§Ã£o (30 Ãºltimas)</h2>
      <div class="small">Vem do tÃ³pico <span class="mono">â€¦/logs</span> (retained) e atualiza em tempo real.</div>
      <table id="logsTbl" style="margin-top:8px">
        <thead>
          <tr>
            <th>InÃ­cio</th><th>Fim</th><th>Motivo</th><th>ADC (iniâ†’fim)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <hr style="border:none;border-top:1px solid #eee;margin:12px 0">

      <h2>ACK / Debug</h2>
      <pre id="dbg">â€”</pre>
    </div>
  </div>

<script>
  const DEVICE_ID = "irrigacao01";
  const BASE = `irrigacao/${DEVICE_ID}`;
  const TOPIC_CMD   = `${BASE}/cmd`;
  const TOPIC_ACK   = `${BASE}/ack`;
  const TOPIC_STATUS= `${BASE}/status`;
  const TOPIC_LOGS  = `${BASE}/logs`;

  document.getElementById("devIdLbl").textContent = DEVICE_ID;
  document.getElementById("baseLbl").textContent = BASE;

  let client = null;
  let lastStatus = null;

  // defaults do seu cluster (vocÃª pode deixar preenchido)
  const defaults = {
    host: "f39abc7b833944818687793a7175eed4.s1.eu.hivemq.cloud",
    port: "8884",
    path: "/mqtt"
  };

  // load localStorage
  function loadSaved() {
    document.getElementById("host").value = localStorage.getItem("mqtt_host") || defaults.host;
    document.getElementById("port").value = localStorage.getItem("mqtt_port") || defaults.port;
    document.getElementById("path").value = localStorage.getItem("mqtt_path") || defaults.path;
    document.getElementById("user").value = localStorage.getItem("mqtt_user") || "";
    document.getElementById("pass").value = localStorage.getItem("mqtt_pass") || "";
  }
  loadSaved();

  function setConn(ok, msg){
    const el = document.getElementById("connState");
    el.textContent = msg;
    el.className = ok ? "ok" : "bad";
  }

  function logDbg(obj){
    const el = document.getElementById("dbg");
    const t = new Date().toLocaleString();
    el.textContent = `[${t}] ${typeof obj === "string" ? obj : JSON.stringify(obj, null, 2)}\n\n` + el.textContent;
  }

  function connect(){
    const host = document.getElementById("host").value.trim();
    const port = document.getElementById("port").value.trim();
    const path = document.getElementById("path").value.trim() || "/mqtt";
    const user = document.getElementById("user").value.trim();
    const pass = document.getElementById("pass").value;

    localStorage.setItem("mqtt_host", host);
    localStorage.setItem("mqtt_port", port);
    localStorage.setItem("mqtt_path", path);
    localStorage.setItem("mqtt_user", user);
    localStorage.setItem("mqtt_pass", pass);

    const url = `wss://${host}:${port}${path}`;
    const clientId = `web-${DEVICE_ID}-${Math.random().toString(16).slice(2)}`;

    setConn(false, "Conectando...");
    logDbg(`Conectando em ${url} ...`);

    client = mqtt.connect(url, {
      clientId,
      username: user || undefined,
      password: pass || undefined,
      keepalive: 30,
      clean: true,
      reconnectPeriod: 2000,
      connectTimeout: 10_000
    });

    client.on("connect", () => {
      setConn(true, "Conectado");
      logDbg("âœ… Conectado!");

      client.subscribe([TOPIC_STATUS, TOPIC_LOGS, TOPIC_ACK], { qos: 0 }, (err) => {
        if (err) logDbg({subErr: err.message});
        else logDbg(`ðŸ“¡ Inscrito em: ${TOPIC_STATUS}, ${TOPIC_LOGS}, ${TOPIC_ACK}`);
      });

      // pede um ACK sÃ³ pra confirmar ida/volta
      requestPing();
    });

    client.on("reconnect", () => setConn(false, "Reconectando..."));
    client.on("close", () => setConn(false, "Desconectado"));
    client.on("error", (e) => logDbg({mqttError: e.message}));

    client.on("message", (topic, payload) => {
      const txt = payload.toString();
      if (topic === TOPIC_STATUS) {
        try {
          const j = JSON.parse(txt);
          lastStatus = j;
          updateDisplay(j);
          // tambÃ©m preenche inputs se ainda estiverem vazios
          hydrateInputsFromStatus(j);
        } catch(e) {
          logDbg({statusParseErr: e.message, txt});
        }
      } else if (topic === TOPIC_LOGS) {
        try {
          const j = JSON.parse(txt);
          renderLogs(j);
        } catch(e) {
          logDbg({logsParseErr: e.message, txt});
        }
      } else if (topic === TOPIC_ACK) {
        try { logDbg(JSON.parse(txt)); }
        catch { logDbg(txt); }
      }
    });
  }

  function disconnect(){
    if (client) {
      client.end(true);
      client = null;
    }
    setConn(false, "Desconectado");
  }

  function publishCmd(obj){
    if (!client || !client.connected) {
      alert("MQTT nÃ£o estÃ¡ conectado.");
      return;
    }
    const msg = JSON.stringify(obj);
    client.publish(TOPIC_CMD, msg, { qos: 0, retain: false });
    logDbg({send: TOPIC_CMD, msg: obj});
  }

  // ===== comandos =====
  function setModeAuto(){ publishCmd({ mode: "AUTO" }); }
  function manualOn(){ publishCmd({ manual: "ON" }); }
  function manualOff(){ publishCmd({ manual: "OFF" }); }
  function requestPing(){ publishCmd({ ping: 1 }); }

  function saveCfg(){
    const thr = parseInt(document.getElementById("threshold").value || "1900", 10);
    const readMin = parseInt(document.getElementById("readMin").value || "30", 10);
    const irrMin  = parseInt(document.getElementById("irrMin").value || "5", 10);
    const stableN = parseInt(document.getElementById("stableN").value || "3", 10);

    const readMs = Math.max(10_000, Math.min(24*60*60*1000, readMin*60_000));
    const irrMs  = Math.max(5_000, Math.min(60*60*1000, irrMin*60_000));

    publishCmd({
      set: { threshold: thr, readMs, irrMs, stableN }
    });
  }

  // ===== UI =====
  function updateDisplay(j){
    document.getElementById("ip").textContent = j.ip ?? "â€”";
    document.getElementById("rssi").textContent = (j.rssi ?? "â€”");
    document.getElementById("mode").textContent = translateMode(j.mode);
    document.getElementById("relay").textContent = (j.relay === "on" ? "LIGADO" : "DESLIGADO");
    document.getElementById("watering").textContent = (j.watering ? "SIM" : "NÃƒO");
    document.getElementById("adcRaw").textContent = j.adcRaw ?? "â€”";
    document.getElementById("moistureState").textContent = translateState(j.moistureState);
    document.getElementById("moisturePct").textContent = (j.moisturePct ?? "â€”") + "%";
    document.getElementById("thrNow").textContent = j.threshold ?? "â€”";
    document.getElementById("readMsNow").textContent = j.readMs ?? "â€”";
    document.getElementById("irrMsNow").textContent = j.irrMs ?? "â€”";
    document.getElementById("stableNNow").textContent = j.stableN ?? "â€”";
    document.getElementById("counts").textContent = `${j.aboveCount ?? "â€”"} / ${j.belowCount ?? "â€”"}`;
    document.getElementById("uptime").textContent = j.uptimeMs ?? "â€”";
  }

  function hydrateInputsFromStatus(j){
    const thr = document.getElementById("threshold");
    const readMin = document.getElementById("readMin");
    const irrMin = document.getElementById("irrMin");
    const stableN = document.getElementById("stableN");

    if (!thr.value) thr.value = j.threshold ?? "";
    if (!stableN.value) stableN.value = j.stableN ?? "";

    if (!readMin.value && j.readMs) readMin.value = Math.round(j.readMs/60_000);
    if (!irrMin.value && j.irrMs) irrMin.value = Math.round(j.irrMs/60_000);
  }

  function renderLogs(j){
    const tbody = document.querySelector("#logsTbl tbody");
    tbody.innerHTML = "";

    const items = j.items || [];
    for (const it of items) {
      const tr = document.createElement("tr");
      const start = fmtEpoch(it.startEpoch);
      const end   = fmtEpoch(it.endEpoch);
      const reason= translateReason(it.stopReason);
      const adc   = `${it.startAdc ?? "â€”"} â†’ ${it.endAdc ?? "â€”"}`;

      tr.innerHTML = `<td>${start}</td><td>${end}</td><td>${reason}</td><td class="mono">${adc}</td>`;
      tbody.appendChild(tr);
    }
  }

  function fmtEpoch(e){
    if (!e || e === 0) return "â€”";
    // epoch estÃ¡ em UTC; converte para horÃ¡rio local do navegador
    return new Date(e*1000).toLocaleString();
  }

  function translateMode(m){
    if (!m) return "â€”";
    if (m === "auto") return "AUTO";
    if (m === "on") return "MANUAL (ON)";
    if (m === "off") return "MANUAL (OFF)";
    return m;
  }

  function translateState(s){
    if (!s) return "â€”";
    if (s === "seco") return "SECO";
    if (s === "molhado") return "MOLHADO";
    if (s === "limite") return "NO LIMITE";
    return s;
  }

  function translateReason(r){
    if (r === 1) return "Parou: molhou";
    if (r === 2) return "Parou: tempo mÃ¡x";
    if (r === 3) return "Parou: forÃ§ado";
    return r ?? "â€”";
  }
</script>
</body>
</html>
