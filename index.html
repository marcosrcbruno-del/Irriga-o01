<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel Irrigação (MQTT)</title>
  <style>
    body{font-family:Arial;margin:20px;background:#f4f4f9}
    .card{padding:18px;border:1px solid #ddd;border-radius:12px;max-width:980px;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .row{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px solid #eee}
    .k{font-weight:bold}
    .v{font-family:monospace}
    button{padding:10px 14px;margin:6px 6px 6px 0;cursor:pointer;border:none;border-radius:8px;font-weight:bold}
    .b1{background:#0d6efd;color:#fff}
    .b2{background:#198754;color:#fff}
    .b3{background:#dc3545;color:#fff}
    input{padding:8px;width:100%;max-width:220px;border:1px solid #ccc;border-radius:8px}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid #eee;padding:8px;font-size:13px;text-align:left;vertical-align:top}
    .small{color:#666;font-size:12px;margin-top:8px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eee;font-weight:bold}
  </style>
</head>
<body>
  <div class="card">
    <h2>Painel Irrigação (MQTT)</h2>

    <div class="row"><div class="k">Broker</div><div class="v"><span id="mqttState" class="pill">desconectado</span></div></div>
    <div class="row"><div class="k">Último status</div><div class="v" id="lastStatus">—</div></div>

    <h3>2) Status (igual ao painel do IP)</h3>

    <div class="row"><div class="k">IP</div><div class="v" id="ip">—</div></div>
    <div class="row"><div class="k">Wi-Fi RSSI</div><div class="v" id="rssi">—</div></div>
    <div class="row"><div class="k">Modo</div><div class="v" id="mode">—</div></div>
    <div class="row"><div class="k">Relé</div><div class="v" id="relay">—</div></div>
    <div class="row"><div class="k">Irrigando</div><div class="v" id="watering">—</div></div>
    <div class="row"><div class="k">ADC</div><div class="v" id="adcRaw">—</div></div>
    <div class="row"><div class="k">Estado</div><div class="v" id="moistureState">—</div></div>
    <div class="row"><div class="k">% (simples)</div><div class="v" id="moisturePct">—</div></div>
    <div class="row"><div class="k">Threshold</div><div class="v" id="threshold">—</div></div>
    <div class="row"><div class="k">Leitura (ms)</div><div class="v" id="readMs">—</div></div>
    <div class="row"><div class="k">Irrigação máx (ms)</div><div class="v" id="irrMs">—</div></div>
    <div class="row"><div class="k">Estável N</div><div class="v" id="stableN">—</div></div>
    <div class="row"><div class="k">Acima / Abaixo</div><div class="v" id="ab">—</div></div>
    <div class="row"><div class="k">Uptime (ms)</div><div class="v" id="uptimeMs">—</div></div>

    <h3>3) Comandos (via MQTT)</h3>
    <button class="b1" onclick="sendModeAuto()">Modo AUTO</button>
    <button class="b2" onclick="sendManualOn()">Manual ON</button>
    <button class="b3" onclick="sendManualOff()">Manual OFF</button>

    <h3>Configuração</h3>
    <div class="small">Esses valores são enviados em <code>{ "set": {...} }</code> para o tópico <code>/cmd</code>.</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
      <div>
        <div class="small">Threshold</div>
        <input id="inThreshold" type="number" min="0" max="4095" />
      </div>
      <div>
        <div class="small">Estável N</div>
        <input id="inStableN" type="number" min="1" max="20" />
      </div>
      <div>
        <div class="small">Leitura (ms)</div>
        <input id="inReadMs" type="number" min="200" max="3600000" />
      </div>
      <div>
        <div class="small">Irrigação máx (ms)</div>
        <input id="inIrrMs" type="number" min="500" max="3600000" />
      </div>
    </div>
    <button class="b1" style="margin-top:10px" onclick="sendConfig()">Salvar configuração</button>

    <h3>Logs (últimas 30)</h3>
    <table>
      <thead>
        <tr><th>#</th><th>Início</th><th>Fim</th><th>Duração</th><th>ADC ini</th><th>ADC fim</th><th>Motivo</th></tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const DEVICE_ID = "irrigacao01";
    const HOST = "f39abc7b833944818687793a7175eed4.s1.eu.hivemq.cloud";
    const MQTT_USER = "COLOQUE_AQUI";
    const MQTT_PASS = "COLOQUE_AQUI";

    const base = `irrigacao/${DEVICE_ID}`;
    const T_CMD = `${base}/cmd`;
    const T_ACK = `${base}/ack`;
    const T_STATUS = `${base}/status`;
    const T_LOGS = `${base}/logs`;

    const client = mqtt.connect(`wss://${HOST}:8884/mqtt`, {
      username: MQTT_USER,
      password: MQTT_PASS,
      clientId: `web-${DEVICE_ID}-` + Math.random().toString(16).slice(2),
      clean: true,
      connectTimeout: 8000,
      reconnectPeriod: 2000
    });

    function setMqttState(txt){
      document.getElementById("mqttState").textContent = txt;
    }

    client.on("connect", () => {
      setMqttState("conectado");
      client.subscribe([T_STATUS, T_LOGS, T_ACK], { qos: 0 });
    });

    client.on("reconnect", () => setMqttState("reconectando..."));
    client.on("close", () => setMqttState("desconectado"));
    client.on("error", () => setMqttState("erro"));

    function setText(id, v){ document.getElementById(id).textContent = (v === undefined || v === null) ? "—" : v; }

    function applyStatus(s){
      const now = new Date();
      setText("lastStatus", now.toLocaleString("pt-BR"));
      setText("ip", s.ip);
      setText("rssi", s.rssi);
      setText("mode", s.mode);
      setText("relay", s.relay);
      setText("watering", s.watering);
      setText("adcRaw", s.adcRaw);
      setText("moistureState", s.moistureState);
      setText("moisturePct", s.moisturePct);
      setText("threshold", s.threshold);
      setText("readMs", s.readMs);
      setText("irrMs", s.irrMs);
      setText("stableN", s.stableN);
      setText("ab", `${s.aboveCount} / ${s.belowCount}`);
      setText("uptimeMs", s.uptimeMs);

      // Preenche inputs (se estiverem vazios)
      if (!document.getElementById("inThreshold").value) document.getElementById("inThreshold").value = s.threshold ?? "";
      if (!document.getElementById("inStableN").value) document.getElementById("inStableN").value = s.stableN ?? "";
      if (!document.getElementById("inReadMs").value) document.getElementById("inReadMs").value = s.readMs ?? "";
      if (!document.getElementById("inIrrMs").value) document.getElementById("inIrrMs").value = s.irrMs ?? "";
    }

    function applyLogs(L){
      const body = document.getElementById("logBody");
      body.innerHTML = "";
      const items = (L && L.items) ? L.items : [];
      for(let i=0;i<items.length;i++){
        const it = items[i];
        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td>${i+1}</td>`+
          `<td>${it.start ?? ""}</td>`+
          `<td>${it.end ?? ""}</td>`+
          `<td>${it.durMs ?? ""}</td>`+
          `<td>${it.startAdc ?? ""}</td>`+
          `<td>${it.endAdc ?? ""}</td>`+
          `<td>${it.stopReason ?? ""}</td>`;
        body.appendChild(tr);
      }
    }

    client.on("message", (topic, payload) => {
      try{
        const txt = payload.toString();
        if(topic === T_STATUS){
          applyStatus(JSON.parse(txt));
        } else if(topic === T_LOGS){
          applyLogs(JSON.parse(txt));
        } else if(topic === T_ACK){
          // opcional: você pode exibir o ACK em algum lugar
          // console.log("ACK:", txt);
        }
      }catch(e){
        // console.log("parse err", e);
      }
    });

    function pub(obj){
      client.publish(T_CMD, JSON.stringify(obj), { qos: 0, retain: false });
    }

    function sendModeAuto(){ pub({ mode: "AUTO" }); }
    function sendManualOn(){ pub({ manual: "ON" }); }
    function sendManualOff(){ pub({ manual: "OFF" }); }

    function sendConfig(){
      const threshold = parseInt(document.getElementById("inThreshold").value || "0", 10);
      const stableN = parseInt(document.getElementById("inStableN").value || "3", 10);
      const readMs = parseInt(document.getElementById("inReadMs").value || "60000", 10);
      const irrMs = parseInt(document.getElementById("inIrrMs").value || "300000", 10);
      pub({ set: { threshold, stableN, readMs, irrMs } });
    }
  </script>
</body>
</html>
